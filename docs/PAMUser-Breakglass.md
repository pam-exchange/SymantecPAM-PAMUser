# PAM User for Breakglass

When using the `PAM User` connector for PAM users on one PAM instance it can be considered to create a breakglass account, where the password for a PAM administrator is stored in a local vault. The password is used as last resort if other PAM users are blocked and not able to login to PAM. 

![PAM User for Breakglass](/docs/images/PAMUser-Breakglass.png)

More details about breakglass scenarios and how it can be used is available in the repo [Breakglass](https://github.com/pam-exchange/Breakglass).

In PAM the password update for PAM users is using the API. Main reason is that with the API there is an option to change the password without the user being required to change the password at next login. When using the CLI such an option is not available and a user would be required to change the password at next login.

When using the API it is required to define an ApiKey and associate it with the PAM user.

# PAM setup

## Global Settings

An important update is the password length for PAM users. Default is 16 characters, which is insufficient for the passwords generated by PAM. Update the Flobal Settings and change the password length to 72 characters (maximum length).

![Password Length for PAM Users](/docs/images/GlobalSettings.png)

## PAM User (Login)

The users being managed by PAM is in the example a Global Administrator. It is possible to define other roles and permissions for the user. If so, the ApiKey associated with the PAM user must have permissions to list and search target accounts and target servers. It is possible to define a target group with a limited view of target accounts. This is not used in the example here.

![PAM User - Basic Info](/docs/images/BG-User-1.png)

The role for the PAM user in the example is a `Global Administrator`. 

![PAM User - Roles](/docs/images/BG-User-2.png)

A `Global Administrator` must also have a Credential Managemnt Group associated. 

![PAM User - Credential Manager Groups](/docs/images/BG-User-3.png)

Finally, for the user define an ApiKey. Initially when it is created the ID is zero (0). When the user is saved the ApiKey is created as a target account and the ID will change to a different value

![PAM User - ApiKey](/docs/images/BG-User-4.png)



## ApiKey

The ApiKey created when the user is created is a standard ApiKey. In the example here, the length and age of teh ApiKey is updated, such that it is automatically updated when it reaches a defined age.

The ApiKey is used when the `PAM User` connector is requesting a password update for a PAM user.

### ApiKey - Password Composition Policy

The PCP used for the of ApiKey used here is dynamic and will update when the age reaches 1 day. A different schedule can be used.

![PCP - ApiKey Dynamic](/docs/images/PCP-ApiKey-dynamic.png)

### ApiKey - TargetApplication

It is important to differentiate a standard ApiKey with the dynamic ApiKey used here. A new target application `ApiKey-Dynamic` is created using the PCP with higher length and a age limit.

![TargetApplication - ApiKey Dynamic](/docs/images/BG-TargetApplication-ApiKey.png)

### ApiKey - TargetAccount

Finally, for the ApiKey the internal ID is added to the namge used when the PAM user was created. Identify the correct target account and change the target application to `ApiKey-dynamic`.

![TargetAccount - ApiKey](/docs/images/BG-TargetAccount-ApiKey.png)

When updating the target account for the ApiKey verify that it is synchronizing with PAM and that a new random password is generated with the length defined in the PCP.

## PAM User (Managed)

The PAM user is created as a user object. Create a target application and account using the same username as for the PAM user. 

## PAM User - Password Composition Policy

Create a PCP used for new passwords generated by the `PAM User` connector. If the target account is used for breakglass purposes, it is important that there is no age enforcemwent defined in the PCP.

![PCP - PAM User](/docs/images/PCP-PAMUser-Passwords.png)

### PAMUser - TargetApplication

The PAM User is using a target account existing on a target server, which is the PAM system itself. If using a PAM cluster the target server used here is a member of the primary site.

Cerate the target application using the PCP created for PAM Users.

![TargetApplication - PAM User](/docs/images/BG-TargetApplication-User-1.png)

Use defaults for the tab `PAM User`. The communication path from TCF where the connector is running to PAM should be very good. 

![TargetApplication - PAM User](/docs/images/BG-TargetApplication-User-2.png)


In the tab `PAM User (remote)` verify that the checkbox `PAM is remote` is unchecked.

![TargetApplication - PAM User](/docs/images/BG-TargetApplication-User-3.png)


### PAMUser - TargetAccount

Finally, create a target account using the account name matching the PAM User name. Create new random value for the password. 

![TargetAccount - PAM User](/docs/images/BG-TargetAccount-User-1.png)

In the tab `Password` change the synchronize setting to update both PAM and end-point.

In the tab `PAM User` Set the account type to `PAM User` and use the ApiKey defined when the PAM user was created as the master account.

![TargetAccount - PAM User](/docs/images/BG-TargetAccount-User-2.png)

That's about it. Saving the target account will update the password for the PAM user to a new random value.


# Error handling

If the API call to update the PAM user is failing the API return code is visible in the `$CATALINA_HOME/logs/cataline.log` on the TCF server. 

